<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Пример Дополненной Реальности</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }

    #ar-video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    #ar-button {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <video id="ar-video" autoplay playsinline></video>
  <button id="ar-button">Запустить AR</button>

  <script type="module">
    import * as THREE from 'https://cdn.skypack.dev/three@0.131.3';
    import { ARSession } from 'https://cdn.skypack.dev/three/examples/jsm/xr/ARSession.js';

    let camera, scene, renderer;

    init();

    function init() {
      const video = document.getElementById('ar-video');
      const button = document.getElementById('ar-button');

      navigator.mediaDevices
        .getUserMedia({ video: true })
        .then((stream) => {
          video.srcObject = stream;
          video.onloadedmetadata = () => {
            video.play();
            initAR();
          };
        })
        .catch((err) => {
          console.error(err);
        });

      button.addEventListener('click', () => {
        button.style.display = 'none';
        renderer.xr.enabled = true;
        renderer.xr.getSession().then((session) => {
          session.requestAnimationFrame((time, frame) => {
            render(time, frame);
          });
        });
      });
    }

    function initAR() {
      renderer = new THREE.WebGLRenderer({ alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      scene = new THREE.Scene();

      camera = new THREE.PerspectiveCamera();
      camera.matrixAutoUpdate = false;

      const light = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(light);

      const geometry = new THREE.BoxGeometry(0.1, 0.1, 0.1);
      const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
      const cube = new THREE.Mesh(geometry, material);
      scene.add(cube);

      renderer.xr.enabled = true;
      renderer.xr.setReferenceSpaceType('local');
      renderer.xr.setSession(new ARSession());
    }

    function render(time, frame) {
      if (frame) {
        const pose = frame.getViewerPose(renderer.xr.getReferenceSpace());

        if (pose) {
          const view = pose.views[0];
          camera.projectionMatrix.fromArray(view.projectionMatrix);
          const viewport = renderer.getCurrentViewport();
          camera.viewport = viewport;

          renderer.render(scene, camera);
        }
      }
    }
  </script>
</body>
</html>